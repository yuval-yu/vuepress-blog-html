<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringBoot优雅停机的正确姿势.md | 余瑜的博客</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/yuyujson/cdn-images@latest/blog-images/20210214155749.jpg">
    <meta name="description" content="积一时之跬步,臻千里之遥程">
    <meta name="keywords" content="java博客,博客,java,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.6a96f710.css" as="style"><link rel="preload" href="/assets/js/app.b59d43b0.js" as="script"><link rel="preload" href="/assets/js/2.32a5b7d0.js" as="script"><link rel="preload" href="/assets/js/29.be912580.js" as="script"><link rel="prefetch" href="/assets/js/10.78e68451.js"><link rel="prefetch" href="/assets/js/11.e109c3f5.js"><link rel="prefetch" href="/assets/js/12.6dce10b5.js"><link rel="prefetch" href="/assets/js/13.7fd8ed7d.js"><link rel="prefetch" href="/assets/js/14.27ab1f10.js"><link rel="prefetch" href="/assets/js/15.3cd3f218.js"><link rel="prefetch" href="/assets/js/16.cfadd324.js"><link rel="prefetch" href="/assets/js/17.519041ce.js"><link rel="prefetch" href="/assets/js/18.ed7e71f0.js"><link rel="prefetch" href="/assets/js/19.230facb8.js"><link rel="prefetch" href="/assets/js/20.6ef8123b.js"><link rel="prefetch" href="/assets/js/21.fb782380.js"><link rel="prefetch" href="/assets/js/22.cb6efb4d.js"><link rel="prefetch" href="/assets/js/23.15e01100.js"><link rel="prefetch" href="/assets/js/24.6d671eae.js"><link rel="prefetch" href="/assets/js/25.e8104fe5.js"><link rel="prefetch" href="/assets/js/26.14b8d08f.js"><link rel="prefetch" href="/assets/js/27.0f4ea0f3.js"><link rel="prefetch" href="/assets/js/28.1657c022.js"><link rel="prefetch" href="/assets/js/3.d5a86a18.js"><link rel="prefetch" href="/assets/js/30.508ee957.js"><link rel="prefetch" href="/assets/js/31.b82f4173.js"><link rel="prefetch" href="/assets/js/32.d3049547.js"><link rel="prefetch" href="/assets/js/33.07708f42.js"><link rel="prefetch" href="/assets/js/34.aec051bb.js"><link rel="prefetch" href="/assets/js/35.dd49be3f.js"><link rel="prefetch" href="/assets/js/36.9fd03482.js"><link rel="prefetch" href="/assets/js/37.330d8bb4.js"><link rel="prefetch" href="/assets/js/38.6b6ff415.js"><link rel="prefetch" href="/assets/js/39.0fe6da40.js"><link rel="prefetch" href="/assets/js/4.fee53103.js"><link rel="prefetch" href="/assets/js/40.e73843d6.js"><link rel="prefetch" href="/assets/js/41.2f93e056.js"><link rel="prefetch" href="/assets/js/42.947ed580.js"><link rel="prefetch" href="/assets/js/43.b9fcdfcb.js"><link rel="prefetch" href="/assets/js/44.ac650c37.js"><link rel="prefetch" href="/assets/js/45.28dca716.js"><link rel="prefetch" href="/assets/js/46.c6d9149f.js"><link rel="prefetch" href="/assets/js/47.48f5d292.js"><link rel="prefetch" href="/assets/js/48.b8c9e035.js"><link rel="prefetch" href="/assets/js/49.0befbcdf.js"><link rel="prefetch" href="/assets/js/5.324acea3.js"><link rel="prefetch" href="/assets/js/50.7367c1df.js"><link rel="prefetch" href="/assets/js/51.83626ff9.js"><link rel="prefetch" href="/assets/js/52.89e08b1a.js"><link rel="prefetch" href="/assets/js/53.6e2cb993.js"><link rel="prefetch" href="/assets/js/54.46e1b57f.js"><link rel="prefetch" href="/assets/js/55.f21c86df.js"><link rel="prefetch" href="/assets/js/56.763e66bb.js"><link rel="prefetch" href="/assets/js/57.0c234d89.js"><link rel="prefetch" href="/assets/js/58.ddaed26a.js"><link rel="prefetch" href="/assets/js/59.abbe33db.js"><link rel="prefetch" href="/assets/js/6.1e564d54.js"><link rel="prefetch" href="/assets/js/60.41cc8f36.js"><link rel="prefetch" href="/assets/js/61.b5c08d00.js"><link rel="prefetch" href="/assets/js/62.5af6c4cf.js"><link rel="prefetch" href="/assets/js/63.b3be483a.js"><link rel="prefetch" href="/assets/js/64.e01f7670.js"><link rel="prefetch" href="/assets/js/65.a5aa4815.js"><link rel="prefetch" href="/assets/js/66.32256b09.js"><link rel="prefetch" href="/assets/js/67.308d2b42.js"><link rel="prefetch" href="/assets/js/68.81b8b810.js"><link rel="prefetch" href="/assets/js/69.d030989a.js"><link rel="prefetch" href="/assets/js/7.d371c4f7.js"><link rel="prefetch" href="/assets/js/70.f54ab2ed.js"><link rel="prefetch" href="/assets/js/71.85b10eee.js"><link rel="prefetch" href="/assets/js/72.cf4f2aef.js"><link rel="prefetch" href="/assets/js/73.73d34157.js"><link rel="prefetch" href="/assets/js/74.97bc1098.js"><link rel="prefetch" href="/assets/js/75.ae99cbb1.js"><link rel="prefetch" href="/assets/js/76.eeb239c8.js"><link rel="prefetch" href="/assets/js/77.4e615b08.js"><link rel="prefetch" href="/assets/js/78.cb55387f.js"><link rel="prefetch" href="/assets/js/79.6818a8b2.js"><link rel="prefetch" href="/assets/js/8.7a6d3673.js"><link rel="prefetch" href="/assets/js/80.6d3783f0.js"><link rel="prefetch" href="/assets/js/81.405315c1.js"><link rel="prefetch" href="/assets/js/82.8e172c6a.js"><link rel="prefetch" href="/assets/js/83.8d9783d9.js"><link rel="prefetch" href="/assets/js/84.b11be9ee.js"><link rel="prefetch" href="/assets/js/85.acb3c44e.js"><link rel="prefetch" href="/assets/js/86.74348774.js"><link rel="prefetch" href="/assets/js/87.046d24dc.js"><link rel="prefetch" href="/assets/js/88.04bcb05d.js"><link rel="prefetch" href="/assets/js/89.08fc0a34.js"><link rel="prefetch" href="/assets/js/9.0a2edccd.js"><link rel="prefetch" href="/assets/js/90.567b128d.js"><link rel="prefetch" href="/assets/js/91.80e197c3.js"><link rel="prefetch" href="/assets/js/92.6d99ef37.js"><link rel="prefetch" href="/assets/js/93.e83349b4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6a96f710.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.jsdelivr.net/gh/yuyujson/cdn-images@latest/blog-images/20210216171303.svg" alt="余瑜的博客" class="logo"> <span class="site-name can-hide">余瑜的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JAVA" class="dropdown-title"><a href="/pages/224f8e/" class="link-title">JAVA</a> <span class="title" style="display:none;">JAVA</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/224f8e/" class="nav-link">并发</a></li><li class="dropdown-item"><!----> <a href="/pages/878afc/" class="nav-link">线程池</a></li><li class="dropdown-item"><!----> <a href="/pages/5d39a7/" class="nav-link">spring</a></li><li class="dropdown-item"><!----> <a href="/pages/511867/" class="nav-link">maven</a></li><li class="dropdown-item"><!----> <a href="/pages/2cabac/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/88ba01/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/88ba01/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/e3d657/" class="nav-link">mysql</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/pages/c0a252/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/c0a252/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/pages/2a2df0/" class="nav-link">zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/54315c/" class="nav-link">docker</a></li><li class="dropdown-item"><!----> <a href="/pages/7516d4/" class="nav-link">terminal</a></li><li class="dropdown-item"><!----> <a href="/pages/4ceec8/" class="nav-link">kong插件开发</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><a href="/pages/cad352/" class="link-title">算法</a> <span class="title" style="display:none;">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/cad352/" class="nav-link">资料</a></li><li class="dropdown-item"><!----> <a href="/pages/877b28/" class="nav-link">leetCode-简单</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/pages/c33358/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/c33358/" class="nav-link">blog</a></li><li class="dropdown-item"><!----> <a href="/pages/91e143/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/pages/44ff0f/" class="nav-link">关于</a></div> <a href="https://github.com/yuyujson" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JAVA" class="dropdown-title"><a href="/pages/224f8e/" class="link-title">JAVA</a> <span class="title" style="display:none;">JAVA</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/224f8e/" class="nav-link">并发</a></li><li class="dropdown-item"><!----> <a href="/pages/878afc/" class="nav-link">线程池</a></li><li class="dropdown-item"><!----> <a href="/pages/5d39a7/" class="nav-link">spring</a></li><li class="dropdown-item"><!----> <a href="/pages/511867/" class="nav-link">maven</a></li><li class="dropdown-item"><!----> <a href="/pages/2cabac/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/88ba01/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/88ba01/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/e3d657/" class="nav-link">mysql</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="运维" class="dropdown-title"><a href="/pages/c0a252/" class="link-title">运维</a> <span class="title" style="display:none;">运维</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/c0a252/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/pages/2a2df0/" class="nav-link">zookeeper</a></li><li class="dropdown-item"><!----> <a href="/pages/54315c/" class="nav-link">docker</a></li><li class="dropdown-item"><!----> <a href="/pages/7516d4/" class="nav-link">terminal</a></li><li class="dropdown-item"><!----> <a href="/pages/4ceec8/" class="nav-link">kong插件开发</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><a href="/pages/cad352/" class="link-title">算法</a> <span class="title" style="display:none;">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/cad352/" class="nav-link">资料</a></li><li class="dropdown-item"><!----> <a href="/pages/877b28/" class="nav-link">leetCode-简单</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/pages/c33358/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/c33358/" class="nav-link">blog</a></li><li class="dropdown-item"><!----> <a href="/pages/91e143/" class="nav-link">其他</a></li></ul></div></div><div class="nav-item"><a href="/pages/44ff0f/" class="nav-link">关于</a></div> <a href="https://github.com/yuyujson" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>线程池</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>spring</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/5d39a7/" class="sidebar-link">Spring 统一资源加载策略</a></li><li><a href="/pages/c62f10/" class="sidebar-link">BeanDefinition加载、解析、处理、注册</a></li><li><a href="/pages/7d1cf9/" class="sidebar-link">BeanFactory1-DefaultSingletonBeanRegistry</a></li><li><a href="/pages/095031/" class="sidebar-link">spring-boot-data-elasticsearch</a></li><li><a href="/pages/154d71/" class="sidebar-link">springboot配置Druid监控</a></li><li><a href="/pages/950823/" class="sidebar-link">springboot项目初始化时读取数据库</a></li><li><a href="/pages/c1b2a4/" class="sidebar-link">文件上传</a></li><li><a href="/pages/736b43/" aria-current="page" class="active sidebar-link">SpringBoot优雅停机的正确姿势.md</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/01c2de/" class="sidebar-link">spring源码阅读神器</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>maven</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>JAVA</span></li><li data-v-06225672><span data-v-06225672>spring</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>余瑜</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-08-31</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">SpringBoot优雅停机的正确姿势.md<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p><strong>目录</strong></p> <ul><li><p>何为优雅关机</p></li> <li><p>kill 指令</p></li> <li><p>Runtime.addShutdownHook</p></li> <li><p>Spring 3.2.12</p></li> <li><p>SpringBoot</p></li></ul> <p>再谈为了提醒明知故犯（在一坑里迭倒两次不是不多见），由于业务系统中大量使用了 SpringBoot embedded tomcat 的模式运行，在一些运维脚本中经常看到 Linux 中 kill 指令，然而它的使用也有些讲究，要思考如何能做到优雅停机。</p> <h3 id=""><a href="#" class="header-anchor">#</a></h3> <p><strong>何为优雅关机</strong></p> <p>就是为确保应用关闭时，通知应用进程释放所占用的资源：</p> <ul><li><p>线程池，shutdown（不接受新任务等待处理完）还是 shutdownNow（调用 Thread.interrupt 进行中断）</p></li> <li><p>Socket 链接，比如：Netty、MQ</p></li> <li><p>告知注册中心快速下线（靠心跳机制客服早都跳起来了），比如：Eureka</p></li> <li><p>清理临时文件，比如：POI</p></li> <li><p>各种堆内堆外内存释放</p></li></ul> <p>总之，进程强行终止会带来数据丢失或者终端无法恢复到正常状态，在分布式环境下还可能导致数据不一致的情况。</p> <p><strong>kill 指令</strong></p> <p>kill -9 pid 可以模拟了一次系统宕机，系统断电等极端情况，而 kill -15 pid 则是等待应用关闭，执行阻塞操作，有时候也会出现无法关闭应用的情况（线上理想情况下，是 bug 就该寻根溯源）</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>#查看jvm进程pid
jps
#列出所有信号名称
kill <span class="token operator">-</span>l
 
# Windows下信号常量值
# 简称  全称    数值 
# INT   SIGINT     <span class="token number">2</span>       Ctrl<span class="token operator">+</span>C中断
# ILL   SIGILL     <span class="token number">4</span>       非法指令
# FPE   SIGFPE     <span class="token number">8</span>       floating point <span class="token function">exception</span><span class="token punctuation">(</span>浮点异常<span class="token punctuation">)</span>
# SEGV  SIGSEGV    <span class="token number">11</span>      segment <span class="token function">violation</span><span class="token punctuation">(</span>段错误<span class="token punctuation">)</span>
# TERM  SIGTERM    <span class="token number">5</span>       Software termination signal from <span class="token function">kill</span><span class="token punctuation">(</span>Kill发出的软件终止<span class="token punctuation">)</span>
# BREAK SIGBREAK   <span class="token number">21</span>      Ctrl<span class="token operator">-</span>Break <span class="token function">sequence</span><span class="token punctuation">(</span>Ctrl<span class="token operator">+</span>Break中断<span class="token punctuation">)</span>
# ABRT  SIGABRT    <span class="token number">22</span>      abnormal termination triggered by abort <span class="token function">call</span><span class="token punctuation">(</span>Abort<span class="token punctuation">)</span>
 
#linux信号常量值
# 简称  全称  数值  
# HUP   SIGHUP      <span class="token number">1</span>    终端断线  
# INT   SIGINT      <span class="token number">2</span>    中断（同 Ctrl <span class="token operator">+</span> C）        
# QUIT  SIGQUIT     <span class="token number">3</span>    退出（同 Ctrl <span class="token operator">+</span> \）         
# KILL  SIGKILL     <span class="token number">9</span>    强制终止         
# TERM  SIGTERM     <span class="token number">15</span>    终止         
# CONT  SIGCONT     <span class="token number">18</span>    继续（与STOP相反， fg<span class="token operator">/</span>bg命令）         
# STOP  SIGSTOP     <span class="token number">19</span>    暂停（同 Ctrl <span class="token operator">+</span> Z）        
#<span class="token operator">...</span><span class="token punctuation">.</span>
 
#可以理解为操作系统从内核级别强行杀死某个进程
kill <span class="token operator">-</span><span class="token number">9</span> pid 
#理解为发送一个通知，等待应用主动关闭
kill <span class="token operator">-</span><span class="token number">15</span> pid
#也支持信号常量值全称或简写（就是去掉SIG后）
kill <span class="token operator">-</span>l KILL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>思考：JVM 是如何接受处理 Linux 信号量的？</p> <p>当然是在 JVM 启动时就加载了自定义 SignalHandler，关闭 JVM 时触发对应的 handle。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>public <span class="token keyword">interface</span> SignalHandler <span class="token punctuation">{</span>
    SignalHandler SIG_DFL <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">NativeSignalHandler</span><span class="token punctuation">(</span>0L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SignalHandler SIG_IGN <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">NativeSignalHandler</span><span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    void <span class="token function">handle</span><span class="token punctuation">(</span>Signal var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
class Terminator <span class="token punctuation">{</span>
    private static SignalHandler handler <span class="token operator">=</span> null<span class="token punctuation">;</span>
 
    <span class="token function">Terminator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//jvm设置SignalHandler，在System.initializeSystemClass中触发</span>
    static void <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SignalHandler var0 <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">SignalHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                public void <span class="token function">handle</span><span class="token punctuation">(</span>Signal var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Shutdown<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用Shutdown.exit</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            handler <span class="token operator">=</span> var0<span class="token punctuation">;</span>
 
            try <span class="token punctuation">{</span>
                Signal<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">Signal</span><span class="token punctuation">(</span><span class="token string">&quot;INT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> var0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//中断时</span>
            <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IllegalArgumentException var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            try <span class="token punctuation">{</span>
                Signal<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">Signal</span><span class="token punctuation">(</span><span class="token string">&quot;TERM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> var0<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//终止时</span>
            <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IllegalArgumentException var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>Runtime.addShutdownHook</strong></p> <p>在了解 Shutdown.exit 之前，先看：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span>shutdownHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>则是为 JVM 中增加一个关闭的钩子，当 JVM 关闭的时候调用。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sm<span class="token punctuation">.</span><span class="token function">checkPermission</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RuntimePermission</span><span class="token punctuation">(</span><span class="token string">&quot;shutdownHooks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ApplicationShutdownHooks</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ApplicationShutdownHooks</span> <span class="token punctuation">{</span>
    <span class="token comment">/* The set of registered hooks */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">IdentityHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> hooks<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>hooks <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Shutdown in progress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hook<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Hook already running&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Hook previously registered&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        hooks<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>hook<span class="token punctuation">,</span> hook<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//它含数据结构和逻辑管理虚拟机关闭序列</span>
<span class="token keyword">class</span> <span class="token class-name">Shutdown</span> <span class="token punctuation">{</span>
    <span class="token comment">/* Shutdown 系列状态*/</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> RUNNING <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> HOOKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> FINALIZERS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> state <span class="token operator">=</span> RUNNING<span class="token punctuation">;</span>
    <span class="token comment">/* 是否应该运行所以finalizers来exit? */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> runFinalizersOnExit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 系统关闭钩子注册一个预定义的插槽.</span>
    <span class="token comment">// 关闭钩子的列表如下:</span>
    <span class="token comment">// (0) Console restore hook</span>
    <span class="token comment">// (1) Application hooks</span>
    <span class="token comment">// (2) DeleteOnExit hook</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_SYSTEM_HOOKS <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hooks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">[</span>MAX_SYSTEM_HOOKS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前运行关闭钩子的钩子的索引</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> currentRunningHook <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">/* 前面的静态字段由这个锁保护 */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">/* 为native halt方法提供锁对象 */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> haltLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> slot<span class="token punctuation">,</span> <span class="token keyword">boolean</span> registerShutdownInProgress<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>slot<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span><span class="token string">&quot;Shutdown hook at slot &quot;</span> <span class="token operator">+</span> slot <span class="token operator">+</span> <span class="token string">&quot; already registered&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registerShutdownInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//执行shutdown过程中不添加hook</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">&gt;</span> RUNNING<span class="token punctuation">)</span><span class="token comment">//如果已经在执行shutdown操作不能添加hook</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Shutdown in progress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//如果hooks已经执行完毕不能再添加hook。如果正在执行hooks时，添加的槽点小于当前执行的槽点位置也不能添加</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">&gt;</span> HOOKS <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> HOOKS <span class="token operator">&amp;&amp;</span> slot <span class="token operator">&lt;=</span> currentRunningHook<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Shutdown in progress&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
 
            hooks<span class="token punctuation">[</span>slot<span class="token punctuation">]</span> <span class="token operator">=</span> hook<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 执行所有注册的hooks
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_SYSTEM_HOOKS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Runnable</span> hook<span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// acquire the lock to make sure the hook registered during</span>
                    <span class="token comment">// shutdown is visible here.</span>
                    currentRunningHook <span class="token operator">=</span> i<span class="token punctuation">;</span>
                    hook <span class="token operator">=</span> hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> hook<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token keyword">instanceof</span> <span class="token class-name">ThreadDeath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ThreadDeath</span> td <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ThreadDeath</span><span class="token punctuation">)</span>t<span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> td<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 关闭JVM的操作
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">halt</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>haltLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">halt0</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//JNI方法</span>
    <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">halt0</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// shutdown的执行顺序：runHooks &gt; runFinalizersOnExit</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* Guard against the possibility of a daemon thread invoking exit
             * after DestroyJavaVM initiates the shutdown sequence
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> HOOKS<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">runHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> rfoe<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            state <span class="token operator">=</span> FINALIZERS<span class="token punctuation">;</span>
            rfoe <span class="token operator">=</span> runFinalizersOnExit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rfoe<span class="token punctuation">)</span> <span class="token function">runAllFinalizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//Runtime.exit时执行，runHooks &gt; runFinalizersOnExit &gt; halt</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> runMoreFinalizers <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> runFinalizersOnExit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> RUNNING<span class="token operator">:</span>       <span class="token comment">/* Initiate shutdown */</span>
                state <span class="token operator">=</span> HOOKS<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HOOKS<span class="token operator">:</span>         <span class="token comment">/* Stall and halt */</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> FINALIZERS<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/* Halt immediately on nonzero status */</span>
                    <span class="token function">halt</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">/* Compatibility with old behavior:
                     * Run more finalizers and then halt
                     */</span>
                    runMoreFinalizers <span class="token operator">=</span> runFinalizersOnExit<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>runMoreFinalizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runAllFinalizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">halt</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Shutdown</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* Synchronize on the class object, causing any other thread
             * that attempts to initiate shutdown to stall indefinitely
             */</span>
            <span class="token function">sequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">halt</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//shutdown操作，与exit不同的是不做halt操作(关闭JVM)</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> RUNNING<span class="token operator">:</span>       <span class="token comment">/* Initiate shutdown */</span>
                state <span class="token operator">=</span> HOOKS<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> HOOKS<span class="token operator">:</span>         <span class="token comment">/* Stall and then return */</span>
            <span class="token keyword">case</span> FINALIZERS<span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Shutdown</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br></div></div><p><strong>Spring 3.2.12</strong></p> <p>在 Spring 中通过 ContextClosedEvent 事件来触发一些动作（可以拓展），主要通过 LifecycleProcessor.onClose 来做 stopBeans。</p> <p>由此可见 Spring 也基于 JVM 做了拓展。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>public abstract class AbstractApplicationContext extends DefaultResourceLoader <span class="token punctuation">{</span>
 public void <span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token punctuation">.</span>shutdownHook <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// No shutdown hook registered yet.</span>
   this<span class="token punctuation">.</span>shutdownHook <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    @Override
    public void <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">doClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
   Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>shutdownHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 protected void <span class="token function">doClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  boolean actuallyClose<span class="token punctuation">;</span>
  synchronized <span class="token punctuation">(</span>this<span class="token punctuation">.</span>activeMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   actuallyClose <span class="token operator">=</span> this<span class="token punctuation">.</span>active <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>this<span class="token punctuation">.</span>closed<span class="token punctuation">;</span>
   this<span class="token punctuation">.</span>closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>actuallyClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Closing &quot;</span> <span class="token operator">+</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
   LiveBeansView<span class="token punctuation">.</span><span class="token function">unregisterApplicationContext</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   try <span class="token punctuation">{</span>
    <span class="token comment">//发布应用内的关闭事件</span>
    <span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">ContextClosedEvent</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   catch <span class="token punctuation">(</span>Throwable ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
   <span class="token comment">// 停止所有的Lifecycle beans.</span>
   try <span class="token punctuation">{</span>
    <span class="token function">getLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   catch <span class="token punctuation">(</span>Throwable ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception thrown from LifecycleProcessor on context close&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
 
   <span class="token comment">// 销毁spring 的 BeanFactory可能会缓存单例的 Bean.</span>
   <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token comment">// 关闭当前应用上下文（BeanFactory）</span>
   <span class="token function">closeBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   <span class="token comment">// 执行子类的关闭逻辑</span>
   <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
   synchronized <span class="token punctuation">(</span>this<span class="token punctuation">.</span>activeMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    this<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
public <span class="token keyword">interface</span> LifecycleProcessor extends Lifecycle <span class="token punctuation">{</span>
 <span class="token comment">/**
  * Notification of context refresh, e.g. for auto-starting components.
  */</span>
 void <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">/**
  * Notification of context close phase, e.g. for auto-stopping components.
  */</span>
 void <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p><strong>SpringBoot</strong></p> <p>到这里就进入重点了，SpringBoot 中有 spring-boot-starter-actuator 模块提供了一个 <a href="https://so.csdn.net/so/search?q=restful&amp;spm=1001.2101.3001.7020" target="_blank" rel="noopener noreferrer">restful<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 接口，用于优雅停机。</p> <p>执行请求 curl -X POST http://127.0.0.1:8088/shutdown ，待关闭成功则返回提示。</p> <p>注：线上环境该 url 需要设置权限，可配合 spring-security 使用或在 nginx 中限制内网访问。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>#启用shutdown
endpoints<span class="token punctuation">.</span>shutdown<span class="token punctuation">.</span>enabled<span class="token operator">=</span><span class="token boolean">true</span>
#禁用密码验证
endpoints<span class="token punctuation">.</span>shutdown<span class="token punctuation">.</span>sensitive<span class="token operator">=</span><span class="token boolean">false</span>
#可统一指定所有endpoints的路径
management<span class="token punctuation">.</span>context<span class="token operator">-</span>path<span class="token operator">=</span><span class="token operator">/</span>manage
#指定管理端口和IP
management<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">8088</span>
management<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
 
#开启shutdown的安全验证（spring<span class="token operator">-</span>security）
endpoints<span class="token punctuation">.</span>shutdown<span class="token punctuation">.</span>sensitive<span class="token operator">=</span><span class="token boolean">true</span>
#验证用户名
security<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token operator">=</span>admin
#验证密码
security<span class="token punctuation">.</span>user<span class="token punctuation">.</span>password<span class="token operator">=</span>secret
#角色
management<span class="token punctuation">.</span>security<span class="token punctuation">.</span>role<span class="token operator">=</span>SUPERUSER
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>SpringBoot 的 shutdown 原理也不复杂，其实还是通过调用 AbstractApplicationContext.close 实现的。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>@<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>
    prefix <span class="token operator">=</span> <span class="token string">&quot;endpoints.shutdown&quot;</span>
<span class="token punctuation">)</span>
public class ShutdownMvcEndpoint extends EndpointMvcAdapter <span class="token punctuation">{</span>
    public <span class="token function">ShutdownMvcEndpoint</span><span class="token punctuation">(</span>ShutdownEndpoint delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">super</span><span class="token punctuation">(</span>delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//post请求</span>
    @<span class="token function">PostMapping</span><span class="token punctuation">(</span>
        produces <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;application/vnd.spring-boot.actuator.v1+json&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    @ResponseBody
    public Object <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>this<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ? <span class="token builtin">new</span> <span class="token function">ResponseEntity</span><span class="token punctuation">(</span>Collections<span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;This endpoint is disabled&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HttpStatus<span class="token punctuation">.</span>NOT_FOUND<span class="token punctuation">)</span> <span class="token punctuation">:</span> super<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@<span class="token function">ConfigurationProperties</span><span class="token punctuation">(</span>
    prefix <span class="token operator">=</span> <span class="token string">&quot;endpoints.shutdown&quot;</span>
<span class="token punctuation">)</span>
public class ShutdownEndpoint extends AbstractEndpoint<span class="token operator">&lt;</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;&gt;</span> implements ApplicationContextAware <span class="token punctuation">{</span>
    private static final Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> NO_CONTEXT_MESSAGE <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>Collections<span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;No context to shutdown.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    private static final Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> SHUTDOWN_MESSAGE <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>Collections<span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Shutting down, bye...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    private ConfigurableApplicationContext context<span class="token punctuation">;</span>
 
    public <span class="token function">ShutdownEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">super</span><span class="token punctuation">(</span><span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//执行关闭</span>
    public Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token punctuation">.</span>context <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> NO_CONTEXT_MESSAGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            boolean var6 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 
            Map var1<span class="token punctuation">;</span>
 
            class NamelessClass_1 implements Runnable <span class="token punctuation">{</span>
                <span class="token function">NamelessClass_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
 
                public void <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    try <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>500L<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>InterruptedException var2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//这个调用的就是AbstractApplicationContext.close</span>
                    ShutdownEndpoint<span class="token punctuation">.</span>this<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
 
            try <span class="token punctuation">{</span>
                var6 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                var1 <span class="token operator">=</span> SHUTDOWN_MESSAGE<span class="token punctuation">;</span>
                var6 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>var6<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Thread thread <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">NamelessClass_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thread<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
 
            Thread thread <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">Thread</span><span class="token punctuation">(</span><span class="token builtin">new</span> <span class="token function">NamelessClass_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> var1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><p>-------------  END  -------------</p></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><!----> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/c1b2a4/" class="prev">文件上传</a></span> <span class="next"><a href="/pages/01c2de/">spring源码阅读神器</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:yuy9501@126.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/yuyujson" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=5381381410" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2018-2022
    <span>逆光世间 | 备案号: <a href="https://beian.miit.gov.cn" target="_blank">京ICP备19016086号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.b59d43b0.js" defer></script><script src="/assets/js/2.32a5b7d0.js" defer></script><script src="/assets/js/29.be912580.js" defer></script>
  </body>
</html>
